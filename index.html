<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Oficial | Urban Riders</title>
<link rel="icon" type="image/png" href="img/logo-ur.png">
<link rel="apple-touch-icon" href="img/logo-ur.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .grid-products { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
    gap: 1rem; 
}
        .product-card { transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); }
        #cart-panel, #checkout-modal { transition: transform 0.3s ease-in-out; }
        #modal-zoom { display: none; background: rgba(0,0,0,0.9); }
        .img-zoom-content { max-width: 90%; max-height: 90vh; object-fit: contain; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
       body {
            background-color: #030712; /* Este es el color oscuro exacto que usa mayorista */
            position: relative;
        }

        header, main, div, section, footer { position: relative; z-index: 1; }
        input:focus { border-color: #eab308 !important; }
    </style>
</head>
<body class="font-sans min-h-screen overflow-x-hidden">

    <div id="modal-zoom" class="fixed inset-0 z-[100] flex items-center justify-center p-4 cursor-zoom-out" onclick="closeZoom()">
        <img id="img-ampliada" src="" class="img-zoom-content rounded-lg shadow-2xl">
    </div>

   <div id="checkout-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border border-white/10 max-h-[90vh] overflow-y-auto">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white border-b border-white/10">
                <h3 id="modal-title" class="font-black italic uppercase tracking-tighter text-lg">Crear Cuenta y Comprar</h3>
                <button onclick="toggleCheckoutModal()" class="hover:text-yellow-500 transition text-white/70">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-4 bg-slate-800 border-b border-white/10 text-center">
                <button type="button" id="btn-toggle-auth" onclick="toggleAuthMode()" class="text-yellow-500 text-sm font-bold uppercase hover:underline">
                    ¿Ya tenés cuenta? Iniciá Sesión acá
                </button>
            </div>

            <form id="form-datos-cliente" class="p-6 space-y-4 bg-slate-800">
                <input type="hidden" id="auth-mode" value="register">
                
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Email</label>
                    <input type="email" id="cust-email" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Contraseña</label>
                    <input type="password" id="cust-password" required minlength="6" placeholder="Mínimo 6 caracteres" class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
                </div>

                <div id="register-fields" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Nombre Completo</label>
                            <input type="text" id="cust-name" class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">DNI / CUIT</label>
                            <input type="text" id="cust-dni" class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">WhatsApp / Teléfono</label>
                        <input type="tel" id="cust-phone" class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Dirección de Entrega</label>
                        <input type="text" id="cust-address" placeholder="Calle, Número, Depto" class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-500 outline-none focus:border-yellow-500 transition">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Ciudad</label>
                            <input type="text" id="cust-city" class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Código Postal</label>
                            <input type="text" id="cust-zip" class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
                        </div>
                    </div>
                </div>
                
                <button type="submit" id="btn-confirmar-pago" class="w-full bg-yellow-500 text-black font-black uppercase py-4 rounded-xl shadow-lg hover:bg-yellow-400 transition flex items-center justify-center gap-2">
                    <span id="btn-text-action">Registrarme y Pagar $</span> <span id="checkout-total-btn">0</span>
                </button>
            </form>
        </div>
    </div>
<div id="contact-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border border-white/10">
        <div class="bg-slate-900 p-4 flex justify-between items-center text-white border-b border-white/10">
            <h3 class="font-black italic uppercase tracking-tighter text-lg text-yellow-500">Enviar Consulta</h3>
            <button onclick="toggleContactModal()" class="hover:text-yellow-500 transition text-white/70">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="form-contacto-email" action="https://formspree.io/f/xwvnkwbn" method="POST" class="p-6 space-y-4 bg-slate-800">
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Nombre Completo</label>
                <input type="text" name="nombre" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Tu Correo Electrónico</label>
                <input type="email" name="_replyto" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Mensaje</label>
                <textarea name="mensaje" rows="4" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition resize-none"></textarea>
            </div>
            <button type="submit" id="btn-envio-contacto" class="w-full bg-yellow-500 text-black font-black uppercase py-4 rounded-xl shadow-lg hover:bg-yellow-400 transition flex items-center justify-center gap-2">
                <i class="fas fa-paper-plane text-lg"></i> Enviar Mensaje
            </button>
        </form>
    </div>
</div>

    <div class="bg-yellow-500 text-black text-[10px] font-bold uppercase py-1 text-center tracking-widest">
        <i class="fas fa-shield-alt mr-2"></i> Compra Protegida con Mercado Pago | Envíos a todo el país
    </div>

    <header class="bg-black text-white p-4 sticky top-0 z-40 shadow-xl border-b border-yellow-500/20">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-500 text-black w-10 h-10 flex items-center justify-center rounded-lg font-black text-xl italic tracking-tighter shadow-[0_0_15px_rgba(234,179,8,0.3)]">UR</div>
                <h1 class="text-2xl font-black italic uppercase tracking-tighter">URBAN <span class="text-yellow-500">RIDERS</span></h1>
            </div>
            <div class="flex items-center gap-6">
                <button onclick="toggleCart()" class="relative hover:text-yellow-500 transition">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-yellow-500 text-black text-[10px] font-bold px-1.5 rounded-full">0</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 min-h-screen">
        <section class="mb-8 bg-white/90 backdrop-blur-md p-6 rounded-2xl border-l-4 border-yellow-500 shadow-md flex flex-col md:flex-row items-center justify-between gap-4">
            <div>
                <h2 class="text-2xl font-black italic uppercase text-black mb-1">
                    ⚡ Estamos en tu camino.
                </h2>
                <p class="text-gray-700 leading-relaxed text-sm md:text-base">
                    Equipamiento y repuestos diseñados para aguantar el uso intensivo. Todo lo que tu máquina necesita para rendir al 100%.
                    <span class="text-gray-400 block mt-1 text-xs italic">(También contamos con una selección de artículos para ciclismo).</span>
                </p>
            </div>
        </section>

        <div class="mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
            <h2 class="text-xl font-bold uppercase italic text-slate-200">Nuestro Catálogo</h2>
            <div class="relative w-full md:w-96">
                <input type="text" id="search-input" placeholder="¿Qué estás buscando?" 
       class="w-full pl-10 pr-4 py-2 border border-white/20 rounded-full outline-none bg-slate-500/30 text-white placeholder-slate-300 focus:border-yellow-500 transition-all">
                <i class="fas fa-search absolute left-4 top-3 text-gray-400"></i>
            </div>
        </div>

        <div id="categories-container" class="flex gap-2 overflow-x-auto pb-6 no-scrollbar"></div>
        <div id="grid-productos" class="grid-products"></div>
<div id="load-more-container" class="mt-12 text-center hidden">
            <button onclick="loadMore()" class="bg-black hover:bg-yellow-500 hover:text-black text-white px-8 py-3 rounded-full font-black uppercase italic transition border border-gray-700 shadow-lg">
                Ver más productos
            </button>
        </div>
    </main>

    <footer class="bg-black text-white mt-20 border-t-4 border-yellow-500">
        <div class="max-w-7xl mx-auto px-6 py-12 border-b border-gray-800">
            <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                <div class="text-center md:text-left">
                    <h3 class="text-2xl font-black italic uppercase">Unite al <span class="text-yellow-500">Club</span></h3>
                    <p class="text-gray-400 text-xs uppercase font-bold tracking-widest mt-1">Recibí ofertas exclusivas y nuevos ingresos</p>
                </div>
                <form id="newsletter-form" class="flex w-full md:w-auto gap-2">
                    <input type="email" id="newsletter-email" placeholder="TU@EMAIL.COM" required class="bg-gray-900 border border-gray-700 px-4 py-3 rounded-lg text-sm focus:outline-none focus:border-yellow-500 w-full md:w-64 font-bold">
                    <button type="submit" class="bg-yellow-500 text-black px-6 py-3 rounded-lg font-black uppercase text-sm hover:bg-yellow-400 transition">Unirse</button>
                </form>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-6 py-16 grid grid-cols-1 md:grid-cols-4 gap-12">
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <div class="bg-yellow-500 text-black p-1.5 rounded font-black italic">UR</div>
                    <span class="text-lg font-black italic uppercase">Urban Riders</span>
                </div>
                <p class="text-yellow-500 text-xs font-black italic uppercase">Estamos en tu camino.</p>
                <p class="text-gray-500 text-[10px] leading-relaxed uppercase font-bold tracking-tighter">
                    Repuestos, accesorios y equipamiento técnico premium para la ruta y el taller.
                </p>
            </div>

            <div>
                <h4 class="text-xs font-black uppercase italic mb-6 border-l-2 border-yellow-500 pl-2">Navegación</h4>
                <ul class="space-y-3 text-[10px] font-bold uppercase tracking-widest text-gray-400">
                    <li><a href="#" class="hover:text-yellow-500 transition">Inicio</a></li>
                    <li><a href="mayorista.html" class="hover:text-yellow-500 transition">Venta Mayorista</a></li>
                    <li><a href="links.html" class="hover:text-yellow-500 transition">Nuestras Redes</a></li>
                    <li><a href="javascript:void(0)" onclick="toggleContactModal()" class="hover:text-yellow-500 transition">Contacto</a></li>
                </ul>
            </div>

            <div>
                <h4 class="text-xs font-black uppercase italic mb-6 border-l-2 border-yellow-500 pl-2">Seguinos</h4>
                <div class="flex gap-4">
                    <a href="#" class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center text-gray-400 hover:bg-yellow-500 hover:text-black transition">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="#" class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center text-gray-400 hover:bg-blue-600 hover:text-white transition">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="https://wa.me/5491112345678" target="_blank" class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center text-gray-400 hover:bg-green-600 hover:text-white transition">
                        <i class="fab fa-whatsapp text-lg"></i>
                    </a>
                </div>
            </div>

            <div>
                <h4 class="text-xs font-black uppercase italic mb-6 border-l-2 border-yellow-500 pl-2">Pagos Seguros</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-zinc-900 p-2 rounded flex items-center justify-center grayscale hover:grayscale-0 transition-all duration-300 border border-gray-800">
                        <i class="fab fa-cc-visa text-2xl text-[#1a1f71]"></i>
                    </div>
                    <div class="bg-zinc-900 p-2 rounded flex items-center justify-center grayscale hover:grayscale-0 transition-all duration-300 border border-gray-800">
                        <i class="fab fa-cc-mastercard text-2xl text-[#eb001b]"></i>
                    </div>
                    <div class="bg-zinc-900 p-2 rounded flex items-center justify-center grayscale hover:grayscale-0 transition-all duration-300 border border-gray-800 gap-1 text-[#009ee3]">
                        <i class="fas fa-handshake text-sm"></i>
                        <span class="text-[7px] font-black leading-none uppercase">Mercado<br>Pago</span>
                    </div>
                    <div class="bg-zinc-900 p-2 rounded flex items-center justify-center grayscale hover:grayscale-0 transition-all duration-300 border border-gray-800">
                        <i class="fab fa-cc-paypal text-2xl text-[#003087]"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-zinc-950 py-6 text-center">
            <p class="text-[9px] text-gray-700 font-black uppercase tracking-[0.3em]">© 2026 URBAN RIDERS - OFFICIAL STORE</p>
        </div>
    </footer>

    <div id="cart-panel" class="fixed inset-y-0 right-0 w-full md:w-96 bg-slate-900 shadow-2xl z-50 transform translate-x-full border-l border-white/10">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <h3 class="text-xl font-black uppercase italic text-white">Mi Carrito</h3>
                    <button onclick="clearCart()" class="text-xs text-red-500 hover:text-red-700 font-bold uppercase flex items-center gap-1 transition"><i class="fas fa-trash-alt"></i> Vaciar</button>
                </div>
                <button onclick="toggleCart()" class="text-white/70 hover:text-white transition-colors">
    <i class="fas fa-times text-xl"></i>
</button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto space-y-4"></div>
            <div class="border-t pt-6 mt-6">
                <div class="flex justify-between text-xl font-black uppercase mb-4 text-white">
                    <span>Total</span>
                    <span id="cart-total">$0</span>
                </div>
                <button onclick="preCheckout()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold uppercase hover:bg-blue-700 transition flex items-center justify-center gap-2 mb-2 shadow-lg shadow-blue-500/20">
                    <i class="fas fa-credit-card"></i> Pagar con Mercado Pago
                </button>
                <button id="btn-whatsapp-confirmar" onclick="checkoutWA()" class="w-full border-2 border-green-600 text-green-600 py-2 rounded-xl font-bold uppercase hover:bg-green-50 transition flex items-center justify-center gap-2 opacity-50 pointer-events-none">
    <i class="fab fa-whatsapp"></i> Consultar por WhatsApp
</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://dsexvmstfjadjdbptmzn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzZXh2bXN0ZmphZGpkYnB0bXpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2OTc3MzUsImV4cCI6MjA4MjI3MzczNX0.L0Wz3hwZOarNLqkYH5-RAzz2Y6iwI4uaE_rlkcKkgyg';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: {
        storage: window.sessionStorage
    }
});
        const MP_ACCESS_TOKEN = 'TU_ACCESS_TOKEN_AQUÍ'; 
// Este vigilante detecta cambios de sesión en TIEMPO REAL
let currentUser = null; // Memoria del usuario logueado

// Este vigilante detecta cambios de sesión en TIEMPO REAL
_supabase.auth.onAuthStateChange((event, session) => {
    console.log("Evento de seguridad detectado:", event);
    currentUser = session ? session.user : null;

    // No importa si entra o sale, en el index siempre queremos 
    // refrescar el catálogo público para asegurar que se vea bien.
    if (typeof loadProducts === 'function') {
        loadProducts();
    }

    // Si el evento es un cierre de sesión, podemos limpiar el carrito
    if (event === 'SIGNED_OUT') {
        cart = []; 
        if (typeof updateCart === 'function') updateCart();
    }
});

        let products = [];
        // Intentamos recuperar el carrito guardado; si no hay nada, empezamos con []
        let cart = JSON.parse(localStorage.getItem('cart_urban')) || [];
        let productosLimite = 15;
        let currentCategory = 'TODOS';
        const CATEGORIAS_LIST = ['TODOS', 'CICLISMO', 'CASCOS', 'INDUMENTARIA', 'ACCESORIOS', 'REPUESTOS'];

       // Variable global para que no falle la memoria
window.catalogo = []; 

async function loadProducts() {
    try {
        // 1. Obtenemos el conteo total
        const { count, error: countError } = await _supabase
            .from('productos_publicos')
            .select('*', { count: 'exact', head: true });

        if (countError) throw countError;

       // 2. Traemos los productos (del 0 al límite actual)
        const { data, error } = await _supabase
            .from('productos_publicos')
            .select('*')
            .order('nombre', { ascending: true })
            .range(0, productosLimite - 1);

        if (error) throw error;

        // --- EL ARREGLO DE MEMORIA ---
        window.catalogo = data; // Guardamos en la variable global segura
        
        // 3. Renderizamos pasando la data segura
        renderCategories(); 
        renderProducts(window.catalogo);

        // 4. Botón Ver Más
        const btnContainer = document.getElementById('load-more-container');
        if (btnContainer) {
            if (count > productosLimite) {
                btnContainer.classList.remove('hidden');
            } else {
                btnContainer.classList.add('hidden');
            }
        }
    } catch (err) {
        console.error("Error cargando catálogo:", err);
    }
}
     
// --- REEMPLAZA TU FUNCIÓN addToCart POR ESTA ---

async function addToCart(id) {
    // 1. INTENTO RÁPIDO: Buscar en la memoria global (window.catalogo o products)
    // Usamos '==' para ignorar si es texto o número
    let p = (window.catalogo || window.products || []).find(prod => prod.id == id);

    // 2. INTENTO FUERTE: Si la memoria falló, vamos a BUSCARLO A SUPABASE
    if (!p) {
        console.warn(`Producto ${id} no estaba en memoria. Buscando en la nube...`);
        try {
            const { data, error } = await _supabase
                .from('productos_publicos')
                .select('*')
                .eq('id', id)
                .single();
            
            if (error || !data) {
                console.error("Error: El producto no existe ni en la base de datos.");
                alert("Hubo un error al agregar el producto. Intente recargar.");
                return;
            }
            p = data; // ¡Lo encontramos!
        } catch (err) {
            console.error("Error de conexión al buscar producto:", err);
            return;
        }
    }

   // 3. AGREGAR AL CARRITO (Ahora que seguro tenemos 'p')
    const item = cart.find(i => i.id == id);
    
    // --- LÍMITE DE STOCK ESTRICTO Y BLINDADO ---
    const stockReal = Number(p.stock) || 0;
    const cantidadEnCarrito = item ? item.quantity : 0;
    
    if (cantidadEnCarrito >= stockReal) {
        alert(`¡Lo sentimos! Solo nos quedan ${stockReal} unidades en stock.`);
        return; // Cortamos la ejecución, no se agrega nada
    }
    // --------------------------------

    if (item) {
        item.quantity++;
    } else {
        // Limpieza de imagen por si acaso
        let imgClean = (p.imagen_url && p.imagen_url !== "undefined") ? p.imagen_url : 'img/logo-ur.png';
        
        cart.push({
            id: p.id,
            nombre: p.nombre,
            precio_minorista: Number(p.precio_minorista || p.precio || 0),
            imagen_url: imgClean,
            quantity: 1,
            stock_maximo: stockReal // Guardamos el tope blindado en el carrito
        });
    }

    // 4. ACTUALIZAR INTERFAZ
    updateCart();
    if(cart.length === 1) toggleCart();
    
    // Feedback visual opcional
    console.log(`Agregado: ${p.nombre}`);
}
        function updateCart() {
    const container = document.getElementById('cart-items');
    const total = document.getElementById('cart-total');
    let sum = 0, items = 0;
    
    container.innerHTML = cart.map(i => {
        const price = i.precio_minorista || 0;
        sum += price * i.quantity; items += i.quantity;
        return `
            <div class="flex gap-4 border-b border-white/10 pb-4">
                <img src="${i.imagen_url}" class="w-16 h-16 object-cover rounded cursor-zoom-in" onclick="openZoom('${i.imagen_url}')">
                <div class="flex-1">
                    <h4 class="font-bold text-xs uppercase text-slate-100">${i.nombre}</h4>
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-sm font-bold text-white">$${Number(price).toLocaleString()}</div>
                        <div class="flex items-center gap-3 bg-slate-800 text-white rounded-lg px-2">
                            <button onclick="changeQty(${i.id}, -1)">-</button>
                            <span class="text-xs font-bold">${i.quantity}</span>
                            <button onclick="changeQty(${i.id}, 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>`;
    }).join('');

    document.getElementById('cart-count').innerText = items;
    total.innerText = `$${sum.toLocaleString()}`;
    document.getElementById('checkout-total-btn').innerText = sum.toLocaleString();

    // --- LAS DOS LÍNEAS QUE SALVAN EL PROYECTO ---
    localStorage.setItem('cart_urban', JSON.stringify(cart)); // Guarda el carrito para que no desaparezca
    habilitarBotonWhatsapp(); // Revisa si el botón debe ser verde o gris
}

function toggleCart() { document.getElementById('cart-panel').classList.toggle('translate-x-full'); }

function toggleCheckoutModal() { 
    document.getElementById('checkout-modal').classList.toggle('hidden');
}

async function preCheckout() { 
    if (cart.length === 0) return alert("Carrito vacío");
    toggleCart(); 
    
    // Si ya está logueado, pre-llenamos sus datos y ocultamos la contraseña
    if (currentUser) {
        document.getElementById('auth-mode').value = 'logged_in';
        document.getElementById('btn-toggle-auth').style.display = 'none';
        document.getElementById('cust-password').parentElement.style.display = 'none';
        document.getElementById('cust-password').required = false;
        document.getElementById('cust-email').value = currentUser.email;
        document.getElementById('cust-email').disabled = true;
        
        try {
            const { data: clienteData } = await _supabase.from('clientes').select('*').eq('auth_id', currentUser.id).single();
            if (clienteData) {
                document.getElementById('cust-name').value = clienteData.nombre || '';
                document.getElementById('cust-dni').value = clienteData.dni || '';
                document.getElementById('cust-phone').value = clienteData.telefono || '';
                document.getElementById('cust-address').value = clienteData.direccion || '';
                document.getElementById('cust-city').value = clienteData.ciudad || '';
                document.getElementById('cust-zip').value = clienteData.cp || '';
            }
        } catch(e) {} // Fallo silencioso si no tiene datos extra aún
        
        document.getElementById('modal-title').innerText = 'Confirmar Datos de Envío';
        document.getElementById('btn-text-action').innerText = 'Confirmar y Pagar $';
    } else {
        setAuthMode('register');
    }
    toggleCheckoutModal(); 
}

function setAuthMode(mode) {
    const authModeInput = document.getElementById('auth-mode');
    const regFields = document.getElementById('register-fields');
    const btnToggle = document.getElementById('btn-toggle-auth');
    const title = document.getElementById('modal-title');
    const btnAction = document.getElementById('btn-text-action');
    
    authModeInput.value = mode;
    
    if (mode === 'login') {
        regFields.style.display = 'none';
        btnToggle.innerText = '¿No tenés cuenta? Registrate acá';
        title.innerText = 'Iniciar Sesión';
        btnAction.innerText = 'Iniciar Sesión y Pagar $';
        document.getElementById('cust-name').required = false;
        document.getElementById('cust-address').required = false;
    } else {
        regFields.style.display = 'block';
        btnToggle.innerText = '¿Ya tenés cuenta? Iniciá Sesión acá';
        title.innerText = 'Crear Cuenta y Comprar';
        btnAction.innerText = 'Registrarme y Pagar $';
        document.getElementById('cust-name').required = true;
        document.getElementById('cust-address').required = true;
    }
}

function toggleAuthMode() {
    const currentMode = document.getElementById('auth-mode').value;
    setAuthMode(currentMode === 'login' ? 'register' : 'login');
}
// --- NUEVA LÓGICA DE PEDIDO INTEGRADA (CON LOGÍSTICA Y WHATSAPP) ---

document.getElementById('form-datos-cliente').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (cart.length === 0) return alert("El carrito está vacío.");
    
    const btn = document.getElementById('btn-confirmar-pago');
    const originalText = btn.innerHTML;
    const authMode = document.getElementById('auth-mode').value;
    
    const emailForm = document.getElementById('cust-email').value.trim();
    const passwordForm = document.getElementById('cust-password').value;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    btn.disabled = true;

    try {
        let finalUserId = currentUser ? currentUser.id : null;
        let clienteNombre = document.getElementById('cust-name').value.trim();
        let clienteDni = document.getElementById('cust-dni').value.trim();
        let clienteTel = document.getElementById('cust-phone').value.trim();
        let clienteDir = document.getElementById('cust-address').value.trim();
        let clienteCiudad = document.getElementById('cust-city').value.trim();
        let clienteCp = document.getElementById('cust-zip').value.trim();
// 1. MANEJAR AUTENTICACIÓN SI NO ESTÁ LOGUEADO
        if (!currentUser) {
            // Intentamos loguear primero (Adivinamos que ya es cliente)
            let { data: authData, error: authError } = await _supabase.auth.signInWithPassword({
                email: emailForm, 
                password: passwordForm
            });

            if (authError) {
                // Si falla el login, verificamos si es porque no existe o puso mal la clave
                if (authError.message.includes("Invalid login credentials") || authError.message.includes("credenciales")) {
                    
                    // Como no pudo loguear, intentamos CREAR la cuenta
                    const { data: regData, error: regError } = await _supabase.auth.signUp({
                        email: emailForm, 
                        password: passwordForm
                    });

                    if (regError) {
                        // Si da error "User already registered", significa que SÍ existía pero le erró a la clave
                        if (regError.message.includes("User already registered") || regError.code === "user_already_exists") {
                            throw new Error("Ya tienes una cuenta. Por favor verifica que tu contraseña sea correcta.");
                        } else {
                            throw new Error("Error al crear cuenta: " + regError.message);
                        }
                    }
                    
                    // Si se creó con éxito:
                    finalUserId = regData.user.id;
                    const { error: perfilError } = await _supabase.from('clientes').insert([{
                        auth_id: finalUserId, tipo_cliente: 'minorista', nombre: clienteNombre,
                        email: emailForm, dni: clienteDni, telefono: clienteTel,
                        direccion: clienteDir, ciudad: clienteCiudad, cp: clienteCp
                    }]);
                    if (perfilError) console.error("Error al guardar perfil:", perfilError);

                } else {
                    throw new Error("Error de inicio de sesión: " + authError.message);
                }
            } else {
                // Si el login fue exitoso en el primer intento:
                finalUserId = authData.user.id;
                const { data: perfilData } = await _supabase.from('clientes').select('*').eq('auth_id', finalUserId).single();
                
                if (perfilData) {
                    clienteNombre = perfilData.nombre || clienteNombre || 'Cliente Minorista';
                    clienteDni = perfilData.dni || clienteDni || ''; 
                    clienteTel = perfilData.telefono || clienteTel || '';
                    clienteDir = perfilData.direccion || clienteDir || '';
                    clienteCiudad = perfilData.ciudad || clienteCiudad || '';
                    clienteCp = perfilData.cp || clienteCp || '';
                }
            }
        } else if (authMode === 'logged_in') {
            await _supabase.from('clientes').update({
                nombre: clienteNombre, dni: clienteDni, telefono: clienteTel,
                direccion: clienteDir, ciudad: clienteCiudad, cp: clienteCp
            }).eq('auth_id', currentUser.id);
        }

        // 2. GUARDAR EL PEDIDO
        const totalCalculado = cart.reduce((sum, item) => sum + (item.precio_minorista * item.quantity), 0);
        
        const { data: pedidoData, error: pedidoError } = await _supabase.from('pedidos').insert([{
            cliente_nombre: clienteNombre, dni_cliente: clienteDni,           
            direccion_envio: clienteDir, ciudad: clienteCiudad, cp: clienteCp,                     
            metodo_envio: 'correo', total: totalCalculado, estado: 'pendiente',        
            estado_pago: 'pendiente', vendedor_nombre: null
        }]).select();

        if (pedidoError) throw pedidoError;
        const pedidoId = pedidoData[0].id;

        // 3. GUARDAR LOS PRODUCTOS
        const detalles = cart.map(item => ({
            pedido_id: pedidoId, producto_nombre: item.nombre,
            cantidad: item.quantity, precio_unitario: item.precio_minorista,
            subtotal: item.precio_minorista * item.quantity
        }));
        
        const { error: errorDetalles } = await _supabase.from('pedido_detalles').insert(detalles);
        if (errorDetalles) throw errorDetalles;

        // 4. ÉXITO Y REDIRECCIÓN
        const successUrl = window.location.origin + window.location.pathname + `?status=success&pedido=${pedidoId}&payment_id=SIM_${Date.now()}`;
        sessionStorage.removeItem('ultimo_pedido_pago');
        window.location.href = successUrl;

    } catch (err) {
        console.error("Error al procesar:", err);
        alert(err.message || "Hubo un error al procesar la operación. Intenta nuevamente.");
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});
        function renderCategories() {
    const container = document.getElementById('categories-container');
    container.innerHTML = CATEGORIAS_LIST.map(cat => `
        <button onclick="filterByCategory('${cat}')" 
            class="px-6 py-2 rounded-full border transition whitespace-nowrap text-xs font-bold
            ${currentCategory === cat 
                ? 'bg-yellow-500 text-black border-yellow-500 shadow-md' 
                : 'bg-slate-500/30 text-slate-200 border-white/10 hover:bg-slate-500/50'}">
            ${cat}
        </button>`).join('');
}

        async function filterByCategory(cat) {
            currentCategory = cat;
            renderCategories(); // Actualiza visualmente los botones

            const btnContainer = document.getElementById('load-more-container');

            try {
                // Iniciamos la consulta base a la tabla 'productos'
            let query = _supabase
                .from('productos_publicos')
                .select('*'); 

                // Si la categoría no es 'TODOS', aplicamos el filtro específico
                if (cat !== 'TODOS') {
                    query = query.eq('categoria', cat);
                }

                const { data, error } = await query.order('nombre', { ascending: true });

                if (error) throw error;

                // Renderizamos los productos de esa categoría
                renderProducts(data);

                // Ocultamos el botón "Ver más" cuando se filtra por categoría
                // para evitar conflictos con la paginación inicial
                if (btnContainer) {
                    if (cat === 'TODOS' && data.length > productosLimite) {
                        btnContainer.classList.remove('hidden');
                    } else {
                        btnContainer.classList.add('hidden');
                    }
                }

            } catch (err) {
                console.error("Error al filtrar por categoría:", err);
            }
        }
// Lógica de búsqueda global en toda la base de datos de Supabase
        document.getElementById('search-input').addEventListener('input', async (e) => {
            const term = e.target.value.trim();
            const btnContainer = document.getElementById('load-more-container');

            // Si el buscador está vacío, restauramos la vista inicial de 12 productos
            if (term === "") {
                loadProducts();
                return;
            }

            try {
                // Buscamos en toda la tabla 'productos' por coincidencia de nombre
            const { data, error } = await _supabase
                .from('productos_publicos')
                .select('*')
                .ilike('nombre', `%${term}%`) // No distingue mayúsculas/minúsculas
                    .order('nombre', { ascending: true });

                if (error) throw error;

                // Actualizamos la variable global y renderizamos los resultados
                products = data;
                renderProducts(products);
                
                // Ocultamos el botón "Ver más" durante la búsqueda
                if (btnContainer) btnContainer.classList.add('hidden');

            } catch (err) {
                console.error("Error en búsqueda global:", err);
            }
        });
        
      function renderProducts(list) {
    const container = document.getElementById('grid-productos');
    if (!container) return;

    container.innerHTML = list.map(p => {
        let imgClean = (p.imagen_url && p.imagen_url !== "undefined") ? p.imagen_url : 'img/logo-ur.png';
        let precio = Number(p.precio_minorista) || Number(p.precio) || 0;
        
        // --- LÓGICA DE STOCK (AGOTADO) ---
        const sinStock = p.stock <= 0;
        
        // Cartel flotante rojo si no hay stock
        const badgeAgotado = sinStock 
            ? `<div class="absolute top-2 right-2 bg-red-600 text-white text-[9px] font-black px-2 py-1 rounded shadow-lg uppercase tracking-widest z-10">Agotado</div>` 
            : '';
        
        // Botón gris anulado si no hay stock, botón negro normal si hay stock
        const botonAccion = sinStock 
            ? `<button disabled class="bg-slate-800 text-slate-600 w-8 h-8 rounded-full flex items-center justify-center cursor-not-allowed border border-slate-700">
                    <i class="fas fa-times text-xs"></i>
               </button>`
            : `<button onclick="addToCart('${p.id}')" class="bg-black text-white w-8 h-8 rounded-full hover:bg-yellow-500 hover:text-black transition flex items-center justify-center shadow-lg">
                    <i class="fas fa-plus text-xs"></i>
               </button>`;

        return `
            <div class="product-card bg-slate-500/50 backdrop-blur-sm rounded-2xl overflow-hidden shadow-xl border border-white/10 p-3 relative ${sinStock ? 'opacity-80' : ''}">
                ${badgeAgotado}
                <div class="relative mb-2 cursor-zoom-in flex justify-center" onclick="openZoom('${imgClean}')">
                    <img src="${imgClean}" class="w-full h-32 object-contain ${sinStock ? 'grayscale opacity-60' : ''}" onerror="this.src='img/logo-ur.png'">
                </div>
                <div class="text-[9px] text-yellow-600 font-bold uppercase mb-1">${p.categoria || 'Varios'}</div>
                <h3 class="font-bold text-white leading-tight h-8 mb-2 uppercase text-[12px] line-clamp-2">${p.nombre}</h3>
                <div class="flex items-end justify-between">
                    <div class="text-lg font-black text-white">$${precio.toLocaleString()}</div>
                    ${botonAccion}
                </div>
            </div>`;
    }).join('');
}
        function changeQty(id, delta) {
            // Usamos == para que no falle si el ID viene como texto o número
            const item = cart.find(i => i.id == id);
            if (!item) return;

            // Si intenta sumar (delta > 0), validamos contra el stock blindado
            if (delta > 0) {
                // Buscamos el stock real en el catálogo global
                let productoReal = (window.catalogo || []).find(prod => prod.id == id);
                let limite = productoReal ? (Number(productoReal.stock) || 0) : (Number(item.stock_maximo) || 99);

                if (item.quantity >= limite) {
                    alert(`Has alcanzado el límite de stock disponible (${limite} unidades).`);
                    return; // Frenamos la suma
                }
            }

            item.quantity += delta;
            if (item.quantity <= 0) cart = cart.filter(i => i.id != id);
            updateCart();
        }
        function clearCart() { if (confirm("¿Vaciar?")) { cart = []; updateCart(); toggleCart(); } }
        function openZoom(url) { document.getElementById('img-ampliada').src = url; document.getElementById('modal-zoom').style.display = 'flex'; }
        function closeZoom() { document.getElementById('modal-zoom').style.display = 'none'; }
      function checkoutWA() {
    const pedidoId = sessionStorage.getItem('ultimo_pedido_pago');
    
    if (!pedidoId) {
        alert("Debes completar el pago antes de enviar el pedido.");
        return;
    }

    let msg = `¡Hola Urban Riders! 👋\n`;
    msg += `✅ *PAGO CONFIRMADO DEL PEDIDO #${pedidoId}*\n\n`;
    msg += `*Detalle:* \n`;

    // Generamos el mensaje con los productos que SIGUEN en el carrito
    cart.forEach(item => { 
        msg += `• ${item.nombre} (Cant: ${item.quantity})\n`; 
    });
    
    msg += `\n*TOTAL: ${document.getElementById('cart-total').innerText}*`;
    
    // Abrimos el chat
    window.open(`https://wa.me/5493446645264?text=${encodeURIComponent(msg)}`, '_blank');

    // RECIÉN AHORA limpiamos todo para el próximo cliente
    sessionStorage.removeItem('ultimo_pedido_pago');
    localStorage.removeItem('cart_urban');
    cart = [];
    updateCart(); // El carrito se vacía y el botón vuelve a gris aquí
    closeCart();
}
function loadMore() {
            productosLimite += 12; // Aumentamos la cantidad a mostrar
            loadProducts();        // Recargamos el catálogo
        }
function toggleContactModal() {
            document.getElementById('contact-modal').classList.toggle('hidden');
        }

        document.getElementById('form-contacto-email')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('btn-envio-contacto');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    alert("¡Consulta enviada con éxito! Te responderemos a la brevedad.");
                    form.reset();
                    toggleContactModal();
                } else {
                    alert("Hubo un error al enviar el mensaje.");
                }
            } catch (error) {
                alert("Error de conexión con el servidor.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane text-lg"></i> Enviar Mensaje';
            }
        });

        window.onload = loadProducts;
// Lógica para el formulario del Club (Newsletter)
document.getElementById('newsletter-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const emailInput = document.getElementById('newsletter-email');
    const btn = e.target.querySelector('button');
    
    // Feedback visual para el usuario
    btn.disabled = true;
    const originalText = btn.innerText;
    btn.innerText = "UNIENDO...";

    try {
        const { error } = await _supabase
            .from('suscriptores') // Apuntamos a la tabla que me indicaste
            .insert([{ 
                email: emailInput.value 
                // La fecha_registro se genera sola por el 'default now()' de tu SQL
            }]);

        if (error) {
            // Si el email ya existe, Supabase devolverá un error por el constraint 'unique'
            if (error.code === '23505') {
                alert("Este correo ya forma parte del Club Urban Riders.");
            } else {
                throw error;
            }
        } else {
            alert("¡Te uniste al Club con éxito! Pronto recibirás novedades.");
            emailInput.value = ""; // Limpiamos el campo
        }
    } catch (err) {
        console.error("Error al suscribirse:", err);
        alert("Hubo un problema. Por favor, intenta más tarde.");
    } finally {
        btn.disabled = false;
        btn.innerText = originalText;
    }
});
// --- NUEVA FUNCIÓN INDEPENDIENTE ---
function habilitarBotonWhatsapp() {
    const pedidoIdPago = sessionStorage.getItem('ultimo_pedido_pago');
    const btnWpp = document.getElementById('btn-whatsapp-confirmar');
    
    if (!btnWpp) return;

    if (pedidoIdPago && cart.length > 0) {
        // MODO ACTIVO (Verde)
        btnWpp.classList.remove('opacity-50', 'pointer-events-none', 'text-green-600', 'border-green-600');
        btnWpp.classList.add('bg-green-600', 'text-white');
        btnWpp.innerHTML = `<i class="fab fa-whatsapp"></i> ENVIAR PEDIDO #${pedidoIdPago}`;
    } else {
        // MODO BLOQUEADO (Gris)
        btnWpp.classList.add('opacity-50', 'pointer-events-none', 'text-green-600', 'border-green-600');
        btnWpp.classList.remove('bg-green-600', 'text-white');
        btnWpp.innerHTML = `<i class="fab fa-whatsapp"></i> Consultar por WhatsApp`;
    }
}

// --- INICIALIZACIÓN Y GESTIÓN DE ESTADO ---
window.addEventListener('DOMContentLoaded', async () => {
    // 1. CARGA DEL CATÁLOGO (Esto devuelve los productos a la pantalla)
    await loadProducts();

    // 2. ANALISIS DE URL PARA MERCADO PAGO
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    const pedidoId = urlParams.get('pedido');

    // 3. LIMPIEZA DE SEGURIDAD
    // Si la URL no tiene éxito, borramos permisos viejos de WhatsApp
    if (status !== 'success') {
        sessionStorage.removeItem('ultimo_pedido_pago');
    }

    // 4. PROCESO DE RETORNO DE PAGO
    if (status === 'success' && pedidoId) {
        sessionStorage.setItem('ultimo_pedido_pago', pedidoId);
        
        // Actualizamos Supabase a 'pago'
        await _supabase.from('pedidos').update({ estado_pago: 'pago' }).eq('id', pedidoId);

        alert("¡Pago exitoso! El botón de WhatsApp ya está listo en tu carrito.");

        // --- LINEA DE LIMPIEZA DE URL ---
        // Esto borra los parámetros de la URL sin recargar la página para evitar el alert infinito al refrescar
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }
    
    // 5. REFRESCO DE VISTA (Esto activa el botón si corresponde)
    updateCart(); 
});
    </script>
</body>
</html>
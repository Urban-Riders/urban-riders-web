<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Oficial | Urban Riders</title>
<link rel="icon" type="image/png" href="img/logo-ur.png">
<link rel="apple-touch-icon" href="img/logo-ur.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .grid-products { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
    gap: 1rem; 
}
        .product-card { transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); }
        #cart-panel, #checkout-modal { transition: transform 0.3s ease-in-out; }
        #modal-zoom { display: none; background: rgba(0,0,0,0.9); }
        .img-zoom-content { max-width: 90%; max-height: 90vh; object-fit: contain; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            background: linear-gradient(180deg, #1f2937 0%, #4b5563 100%);
            background-attachment: fixed;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.05; pointer-events: none; z-index: 0;
        }

        header, main, div, section, footer { position: relative; z-index: 1; }
        input:focus { border-color: #eab308 !important; }
    </style>
</head>
<body class="font-sans min-h-screen">

    <div id="modal-zoom" class="fixed inset-0 z-[100] flex items-center justify-center p-4 cursor-zoom-out" onclick="closeZoom()">
        <img id="img-ampliada" src="" class="img-zoom-content rounded-lg shadow-2xl">
    </div>

    <div id="checkout-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    
    <div class="bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border border-white/10">
        
        <div class="bg-slate-900 p-4 flex justify-between items-center text-white border-b border-white/10">
            <h3 class="font-black italic uppercase tracking-tighter text-lg">Envío y Facturación</h3>
            <button onclick="toggleCheckoutModal()" class="hover:text-yellow-500 transition text-white/70">
                <i class="fas fa-times"></i>
            </button>
        </div>
            <form id="form-datos-cliente" class="p-6 space-y-4 bg-slate-800">
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Nombre Completo</label>
            <input type="text" id="cust-name" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
        </div>
        <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">DNI / CUIT</label>
            <input type="text" id="cust-dni" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
        </div>
    </div>
    <div>
        <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Email (Para el comprobante)</label>
        <input type="email" id="cust-email" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
    </div>
    <div>
        <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">WhatsApp / Teléfono</label>
        <input type="tel" id="cust-phone" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
    </div>
    <div>
        <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Dirección de Entrega</label>
        <input type="text" id="cust-address" required placeholder="Calle, Número, Depto" class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-500 outline-none focus:border-yellow-500 transition">
    </div>
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Ciudad</label>
            <input type="text" id="cust-city" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
        </div>
        <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Código Postal</label>
            <input type="text" id="cust-zip" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
        </div>
    </div>
                
                <button type="submit" id="btn-confirmar-pago" class="w-full bg-yellow-500 text-black font-black uppercase py-4 rounded-xl shadow-lg hover:bg-yellow-400 transition flex items-center justify-center gap-2">
                    Ir a pagar $ <span id="checkout-total-btn">0</span>
                </button>
            </form>
        </div>
    </div>
<div id="contact-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border border-white/10">
        <div class="bg-slate-900 p-4 flex justify-between items-center text-white border-b border-white/10">
            <h3 class="font-black italic uppercase tracking-tighter text-lg text-yellow-500">Enviar Consulta</h3>
            <button onclick="toggleContactModal()" class="hover:text-yellow-500 transition text-white/70">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="form-contacto-email" action="https://formspree.io/f/xwvnkwbn" method="POST" class="p-6 space-y-4 bg-slate-800">
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Nombre Completo</label>
                <input type="text" name="nombre" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Tu Correo Electrónico</label>
                <input type="email" name="_replyto" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Mensaje</label>
                <textarea name="mensaje" rows="4" required class="w-full bg-slate-700 border-2 border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-yellow-500 transition resize-none"></textarea>
            </div>
            <button type="submit" id="btn-envio-contacto" class="w-full bg-yellow-500 text-black font-black uppercase py-4 rounded-xl shadow-lg hover:bg-yellow-400 transition flex items-center justify-center gap-2">
                <i class="fas fa-paper-plane text-lg"></i> Enviar Mensaje
            </button>
        </form>
    </div>
</div>

    <div class="bg-yellow-500 text-black text-[10px] font-bold uppercase py-1 text-center tracking-widest">
        <i class="fas fa-shield-alt mr-2"></i> Compra Protegida con Mercado Pago | Envíos a todo el país
    </div>

    <header class="bg-black text-white p-4 sticky top-0 z-40 shadow-xl border-b border-yellow-500/20">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-500 text-black w-10 h-10 flex items-center justify-center rounded-lg font-black text-xl italic tracking-tighter shadow-[0_0_15px_rgba(234,179,8,0.3)]">UR</div>
                <h1 class="text-2xl font-black italic uppercase tracking-tighter">URBAN <span class="text-yellow-500">RIDERS</span></h1>
            </div>
            <div class="flex items-center gap-6">
                <button onclick="toggleCart()" class="relative hover:text-yellow-500 transition">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-yellow-500 text-black text-[10px] font-bold px-1.5 rounded-full">0</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 min-h-screen">
        <section class="mb-8 bg-white/90 backdrop-blur-md p-6 rounded-2xl border-l-4 border-yellow-500 shadow-md">
            <p class="text-gray-700 leading-relaxed text-sm md:text-base">
                En <strong>Urban Riders</strong> nos especializamos en lo que tu moto necesita para estar al 100%. Repuestos, accesorios y cascos de alta resistencia.
                <span class="text-gray-400 block mt-1 text-xs italic">(También contamos con una selección de artículos para ciclismo).</span>
            </p>
        </section>

        <div class="mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
            <h2 class="text-xl font-bold uppercase italic text-slate-200">Nuestro Catálogo</h2>
            <div class="relative w-full md:w-96">
                <input type="text" id="search-input" placeholder="¿Qué estás buscando?" 
       class="w-full pl-10 pr-4 py-2 border border-white/20 rounded-full outline-none bg-slate-500/30 text-white placeholder-slate-300 focus:border-yellow-500 transition-all">
                <i class="fas fa-search absolute left-4 top-3 text-gray-400"></i>
            </div>
        </div>

        <div id="categories-container" class="flex gap-2 overflow-x-auto pb-6 no-scrollbar"></div>
        <div id="grid-productos" class="grid-products"></div>
<div id="load-more-container" class="mt-12 text-center hidden">
            <button onclick="loadMore()" class="bg-black hover:bg-yellow-500 hover:text-black text-white px-8 py-3 rounded-full font-black uppercase italic transition border border-gray-700 shadow-lg">
                Ver más productos
            </button>
        </div>
    </main>

    <footer class="bg-black text-white mt-20 border-t-4 border-yellow-500">
        <div class="max-w-7xl mx-auto px-6 py-12 border-b border-gray-800">
            <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                <div class="text-center md:text-left">
                    <h3 class="text-2xl font-black italic uppercase">Unite al <span class="text-yellow-500">Club</span></h3>
                    <p class="text-gray-400 text-xs uppercase font-bold tracking-widest mt-1">Recibí ofertas exclusivas y nuevos ingresos</p>
                </div>
                <form id="newsletter-form" class="flex w-full md:w-auto gap-2">
                    <input type="email" id="newsletter-email" placeholder="TU@EMAIL.COM" required class="bg-gray-900 border border-gray-700 px-4 py-3 rounded-lg text-sm focus:outline-none focus:border-yellow-500 w-full md:w-64 font-bold">
                    <button type="submit" class="bg-yellow-500 text-black px-6 py-3 rounded-lg font-black uppercase text-sm hover:bg-yellow-400 transition">Unirse</button>
                </form>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-6 py-16 grid grid-cols-1 md:grid-cols-4 gap-12">
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <div class="bg-yellow-500 text-black p-1.5 rounded font-black italic">UR</div>
                    <span class="text-lg font-black italic uppercase">Urban Riders</span>
                </div>
                <p class="text-gray-500 text-[10px] leading-relaxed uppercase font-bold tracking-tighter">
                    Equipamiento premium para motociclistas y ciclistas. Seguridad y estilo en cada rodada.
                </p>
            </div>

            <div>
                <h4 class="text-xs font-black uppercase italic mb-6 border-l-2 border-yellow-500 pl-2">Navegación</h4>
                <ul class="space-y-3 text-[10px] font-bold uppercase tracking-widest text-gray-400">
                    <li><a href="#" class="hover:text-yellow-500 transition">Inicio</a></li>
                    <li><a href="mayorista.html" class="hover:text-yellow-500 transition">Venta Mayorista</a></li>
                    <li><a href="links.html" class="hover:text-yellow-500 transition">Nuestras Redes</a></li>
                    <li><a href="javascript:void(0)" onclick="toggleContactModal()" class="hover:text-yellow-500 transition">Contacto</a></li>
                </ul>
            </div>

            <div>
                <h4 class="text-xs font-black uppercase italic mb-6 border-l-2 border-yellow-500 pl-2">Seguinos</h4>
                <div class="flex gap-4">
                    <a href="#" class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center text-gray-400 hover:bg-yellow-500 hover:text-black transition">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="#" class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center text-gray-400 hover:bg-blue-600 hover:text-white transition">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="https://wa.me/5491112345678" target="_blank" class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center text-gray-400 hover:bg-green-600 hover:text-white transition">
                        <i class="fab fa-whatsapp text-lg"></i>
                    </a>
                </div>
            </div>

            <div>
                <h4 class="text-xs font-black uppercase italic mb-6 border-l-2 border-yellow-500 pl-2">Pagos Seguros</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-zinc-900 p-2 rounded flex items-center justify-center grayscale hover:grayscale-0 transition-all duration-300 border border-gray-800">
                        <i class="fab fa-cc-visa text-2xl text-[#1a1f71]"></i>
                    </div>
                    <div class="bg-zinc-900 p-2 rounded flex items-center justify-center grayscale hover:grayscale-0 transition-all duration-300 border border-gray-800">
                        <i class="fab fa-cc-mastercard text-2xl text-[#eb001b]"></i>
                    </div>
                    <div class="bg-zinc-900 p-2 rounded flex items-center justify-center grayscale hover:grayscale-0 transition-all duration-300 border border-gray-800 gap-1 text-[#009ee3]">
                        <i class="fas fa-handshake text-sm"></i>
                        <span class="text-[7px] font-black leading-none uppercase">Mercado<br>Pago</span>
                    </div>
                    <div class="bg-zinc-900 p-2 rounded flex items-center justify-center grayscale hover:grayscale-0 transition-all duration-300 border border-gray-800">
                        <i class="fab fa-cc-paypal text-2xl text-[#003087]"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-zinc-950 py-6 text-center">
            <p class="text-[9px] text-gray-700 font-black uppercase tracking-[0.3em]">© 2026 URBAN RIDERS - OFFICIAL STORE</p>
        </div>
    </footer>

    <div id="cart-panel" class="fixed inset-y-0 right-0 w-full md:w-96 bg-slate-900 shadow-2xl z-50 transform translate-x-full border-l border-white/10">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <h3 class="text-xl font-black uppercase italic text-white">Mi Carrito</h3>
                    <button onclick="clearCart()" class="text-xs text-red-500 hover:text-red-700 font-bold uppercase flex items-center gap-1 transition"><i class="fas fa-trash-alt"></i> Vaciar</button>
                </div>
                <button onclick="toggleCart()" class="text-white/70 hover:text-white transition-colors">
    <i class="fas fa-times text-xl"></i>
</button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto space-y-4"></div>
            <div class="border-t pt-6 mt-6">
                <div class="flex justify-between text-xl font-black uppercase mb-4 text-white">
                    <span>Total</span>
                    <span id="cart-total">$0</span>
                </div>
                <button onclick="preCheckout()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold uppercase hover:bg-blue-700 transition flex items-center justify-center gap-2 mb-2 shadow-lg shadow-blue-500/20">
                    <i class="fas fa-credit-card"></i> Pagar con Mercado Pago
                </button>
                <button id="btn-whatsapp-confirmar" onclick="checkoutWA()" class="w-full border-2 border-green-600 text-green-600 py-2 rounded-xl font-bold uppercase hover:bg-green-50 transition flex items-center justify-center gap-2 opacity-50 pointer-events-none">
    <i class="fab fa-whatsapp"></i> Consultar por WhatsApp
</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://dsexvmstfjadjdbptmzn.supabase.co';
        // (Tu clave está bien, la dejo tal cual)
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFub24iLCJpYXQiOjE3NjY2OTc3MzUsImV4cCI6MjA4MjI3MzczNX0.L0Wz3hwZOarNLqkYH5-RAzz2Y6iwI4uaE_rlkcKkgyg';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const MP_ACCESS_TOKEN = 'TU_ACCESS_TOKEN_AQUÍ'; 

        // Este vigilante detecta cambios de sesión en TIEMPO REAL
        _supabase.auth.onAuthStateChange((event, session) => {
            console.log("Evento de seguridad detectado:", event);

            if (typeof loadProducts === 'function') {
                loadProducts();
            }

            if (event === 'SIGNED_OUT') {
                cart = []; 
                if (typeof updateCart === 'function') updateCart();
            }
        });

        // --- AQUÍ ESTÁ LA CORRECCIÓN MÁGICA ---
        
        // Usamos window.products para que sea 100% GLOBAL y el botón la encuentre
        window.products = []; 
        
        // Usamos var para asegurar que la paginación no falle
        var productosLimite = 15; 
        
        // Recuperamos el carrito
        let cart = JSON.parse(localStorage.getItem('cart_urban')) || [];
        let currentCategory = 'TODOS';
        const CATEGORIAS_LIST = ['TODOS', 'CICLISMO', 'CASCOS', 'INDUMENTARIA', 'ACCESORIOS', 'REPUESTOS'];

        async function loadProducts() {
    try {
        console.log("--- CARGANDO CATÁLOGO DESDE TABLA MAESTRA ---");

        // 1. Obtenemos el conteo total (CAMBIO: Apuntamos a 'productos')
        const { count, error: countError } = await _supabase
            .from('productos') 
            .select('*', { count: 'exact', head: true })
            .gt('stock', 0);

        if (countError) throw countError;

        // 2. Traemos los datos (CAMBIO: Apuntamos a 'productos')
        const { data, error } = await _supabase
            .from('productos')
            .select('*') // Traemos todo para evitar errores de columnas faltantes
            .gt('stock', 0)
            .order('nombre', { ascending: true })
            .range(0, productosLimite - 1);

        if (error) throw error;

        // 3. ACTUALIZACIÓN GLOBAL (LA SOLUCIÓN AL CLICK)
        // Usamos window.products para asegurar que addToCart los encuentre
        window.products = data; 
        
        console.log(`✅ ${data.length} productos cargados en memoria global.`);

        // Dibujamos usando la variable global
        if (typeof renderCategories === 'function') renderCategories();
        renderProducts(window.products);

        // 4. Lógica del botón "Ver más" (Tu lógica original intacta)
        const btnContainer = document.getElementById('load-more-container');
        if (btnContainer) {
            if (count > productosLimite) {
                btnContainer.classList.remove('hidden');
            } else {
                btnContainer.classList.add('hidden');
            }
        }
    } catch (err) {
        console.error("Error cargando catálogo:", err);
    }
}

      // Reemplaza tu función addToCart completa por esta:
function addToCart(id) {
    // CORRECCIÓN: Usamos '==' en lugar de '===' para que "18" sea igual a 18
    const p = products.find(prod => prod.id == id);
    
    if (!p) {
        console.error("Error: Producto no encontrado en memoria. ID buscado:", id);
        return;
    }

    // CORRECCIÓN: Aquí también usamos '=='
    const item = cart.find(i => i.id == id);
    
    if (item) {
        item.quantity++;
    } else {
        // Lógica de seguridad para evitar datos rotos
        const precioFinal = parseFloat(p.precio_minorista || p.precio || 0);
        const imagenFinal = (p.imagen_url && p.imagen_url !== "undefined") ? p.imagen_url : 'img/logo-ur.png';

        cart.push({
            id: p.id,
            nombre: p.nombre || "Producto Sin Nombre",
            precio_minorista: precioFinal,
            imagen_url: imagenFinal,
            quantity: 1
        });
    }
    updateCart();
    
    // Abrimos el carrito automáticamente al agregar el primer producto
    if(cart.length === 1) toggleCart();
}
function updateCart() {
    const container = document.getElementById('cart-items');
    if (!container) return;

    let sum = 0, items = 0;
    
    container.innerHTML = cart.map(i => {
        // Si i.precio_minorista no existe, price será 0
        const price = Number(i.precio_minorista) || 0;
        sum += price * i.quantity; 
        items += i.quantity;
        
        // Si la URL es undefined o vacía, usamos el logo local
        const imgPath = (i.imagen_url && i.imagen_url !== "undefined") ? i.imagen_url : 'img/logo-ur.png';

        return `
            <div class="flex gap-4 border-b border-white/10 pb-4">
                <img src="${imgPath}" 
                     class="w-16 h-16 object-cover rounded shadow-md" 
                     onerror="this.src='img/logo-ur.png'">
                <div class="flex-1">
                    <h4 class="font-bold text-[10px] uppercase text-slate-100">${i.nombre || 'Producto'}</h4>
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-sm font-bold text-white">$${price.toLocaleString()}</div>
                        <div class="flex items-center gap-3 bg-slate-800 text-white rounded-lg px-2">
                            <button onclick="changeQty(${i.id}, -1)" class="p-1 hover:text-yellow-400">-</button>
                            <span class="text-xs font-bold w-4 text-center">${i.quantity}</span>
                            <button onclick="changeQty(${i.id}, 1)" class="p-1 hover:text-yellow-400">+</button>
                        </div>
                    </div>
                </div>
            </div>`;
    }).join('');

    // Actualizamos los elementos de la interfaz
    const cartCount = document.getElementById('cart-count');
    const cartTotal = document.getElementById('cart-total');
    const checkoutBtn = document.getElementById('checkout-total-btn');

    if(cartCount) cartCount.innerText = items;
    if(cartTotal) cartTotal.innerText = `$${sum.toLocaleString()}`;
    if(checkoutBtn) checkoutBtn.innerText = sum.toLocaleString();

    // Guardamos en memoria
    localStorage.setItem('cart_urban', JSON.stringify(cart));
    habilitarBotonWhatsapp();
}

function toggleCart() { document.getElementById('cart-panel').classList.toggle('translate-x-full'); }
function toggleCheckoutModal() { document.getElementById('checkout-modal').classList.toggle('hidden'); }
function preCheckout() { if (cart.length > 0) { toggleCart(); toggleCheckoutModal(); } else alert("Carrito vacío"); }

document.getElementById('form-datos-cliente').addEventListener('submit', async (e) => {
    e.preventDefault();
    const customer = {
        name: document.getElementById('cust-name').value,
        dni: document.getElementById('cust-dni').value,
        email: document.getElementById('cust-email').value,
        phone: document.getElementById('cust-phone').value,
        address: document.getElementById('cust-address').value,
        city: document.getElementById('cust-city').value,
        zip: document.getElementById('cust-zip').value
    };
    await checkoutMP(customer);
});

     async function checkoutMP(customer) {
    // 0. LIMPIEZA: Borramos rastros de pagos anteriores
    sessionStorage.removeItem('ultimo_pedido_pago');
    
    const btn = document.getElementById('btn-confirmar-pago');
    const originalText = btn.innerText;
    btn.innerText = "Procesando..."; btn.disabled = true;

    try {
        // 1. CALCULAMOS EL TOTAL
        const totalAmount = cart.reduce((acc, item) => acc + (Number(item.precio_minorista) * item.quantity), 0);

        // 2. REGISTRAMOS EL PEDIDO EN SUPABASE (Esto es fundamental para tu control)
        const { data: pedidoData, error: pedidoError } = await _supabase
            .from('pedidos')
            .insert([{
                cliente_nombre: customer.name,
                total: totalAmount,
                estado_pago: 'pendiente',
                estado: 'Pendiente'
            }])
            .select();

        if (pedidoError) throw pedidoError;
        const pedidoId = pedidoData[0].id;

        console.log("Pedido registrado en Supabase con ID:", pedidoId);

        /* IMPORTANTE: Como Mercado Pago no permite crear preferencias desde el navegador (Error de CORS),
           vamos a simular la redirección de éxito para que puedas ver el BOTÓN VERDE funcionando.
           En un entorno real, aquí llamarías a un servidor (Backend).
        */
        
        // Simulamos la URL de retorno exitosa de Mercado Pago
        const successUrl = window.location.origin + window.location.pathname + `?status=success&pedido=${pedidoId}&payment_id=SIM_${Date.now()}`;
        
        alert("Simulando proceso de pago... Al aceptar, volverás con el pedido confirmado.");
        
        // Redirigimos para que se active la lógica de "habilitarBotonWhatsapp"
        window.location.href = successUrl;

    } catch (err) { 
        console.error("Error en el proceso:", err);
        alert("Hubo un error al registrar el pedido en la base de datos."); 
        btn.innerText = originalText; btn.disabled = false; 
    }
}
        function renderCategories() {
    const container = document.getElementById('categories-container');
    container.innerHTML = CATEGORIAS_LIST.map(cat => `
        <button onclick="filterByCategory('${cat}')" 
            class="px-6 py-2 rounded-full border transition whitespace-nowrap text-xs font-bold
            ${currentCategory === cat 
                ? 'bg-yellow-500 text-black border-yellow-500 shadow-md' 
                : 'bg-slate-500/30 text-slate-200 border-white/10 hover:bg-slate-500/50'}">
            ${cat}
        </button>`).join('');
}

        async function filterByCategory(cat) {
            currentCategory = cat;
            renderCategories(); // Actualiza visualmente los botones

            const btnContainer = document.getElementById('load-more-container');

            try {
                // Iniciamos la consulta base a la tabla 'productos'
                let query = _supabase
                    .from('productos_publicos')
                    .select('*')
                    .gt('stock', 0); // Solo productos con stock [cite: 167, 168]

                // Si la categoría no es 'TODOS', aplicamos el filtro específico
                if (cat !== 'TODOS') {
                    query = query.eq('categoria', cat);
                }

                const { data, error } = await query.order('nombre', { ascending: true });

                if (error) throw error;

                // Renderizamos los productos de esa categoría
                renderProducts(data);

                // Ocultamos el botón "Ver más" cuando se filtra por categoría
                // para evitar conflictos con la paginación inicial
                if (btnContainer) {
                    if (cat === 'TODOS' && data.length > productosLimite) {
                        btnContainer.classList.remove('hidden');
                    } else {
                        btnContainer.classList.add('hidden');
                    }
                }

            } catch (err) {
                console.error("Error al filtrar por categoría:", err);
            }
        }
// Lógica de búsqueda global en toda la base de datos de Supabase
        document.getElementById('search-input').addEventListener('input', async (e) => {
            const term = e.target.value.trim();
            const btnContainer = document.getElementById('load-more-container');

            // Si el buscador está vacío, restauramos la vista inicial de 12 productos
            if (term === "") {
                loadProducts();
                return;
            }

            try {
                // Buscamos en toda la tabla 'productos' por coincidencia de nombre
                const { data, error } = await _supabase
                    .from('productos_publicos')
                    .select('*')
                    .gt('stock', 0)
                    .ilike('nombre', `%${term}%`) // No distingue mayúsculas/minúsculas
                    .order('nombre', { ascending: true });

                if (error) throw error;

                // Actualizamos la variable global y renderizamos los resultados
                products = data;
                renderProducts(products);
                
                // Ocultamos el botón "Ver más" durante la búsqueda
                if (btnContainer) btnContainer.classList.add('hidden');

            } catch (err) {
                console.error("Error en búsqueda global:", err);
            }
        });
        
        // Reemplaza tu función renderProducts completa por esta:
function renderProducts(list) {
    const container = document.getElementById('grid-productos');
    
    // Si la lista está vacía, mostramos mensaje
    if(list.length === 0) {
        container.innerHTML = '<p class="text-white text-center col-span-full">No se encontraron productos.</p>';
        return;
    }

    container.innerHTML = list.map(p => {
        // SEGURIDAD DE DATOS (Lo que arreglamos antes)
        const precio = parseFloat(p.precio_minorista || p.precio || 0);
        const imagen = (p.imagen_url && p.imagen_url !== "undefined") ? p.imagen_url : 'img/logo-ur.png';

        return `
            <div class="product-card bg-slate-500/50 backdrop-blur-sm rounded-2xl overflow-hidden shadow-xl border border-white/10 p-3">
                <div class="relative mb-2 cursor-zoom-in flex justify-center" onclick="openZoom('${imagen}')">
                    <img src="${imagen}" class="w-full h-32 object-contain" onerror="this.src='img/logo-ur.png'">
                </div>
                <div class="text-[9px] text-yellow-600 font-bold uppercase mb-1">${p.categoria || 'Varios'}</div>
                <h3 class="font-bold text-white leading-tight h-8 mb-2 uppercase text-[12px] line-clamp-2">${p.nombre}</h3>
                <div class="flex items-end justify-between">
                    <div class="text-lg font-black text-white">$${precio.toLocaleString()}</div>
                    
                    <button onclick="addToCart('${p.id}')" 
                            class="bg-black text-white w-8 h-8 rounded-full hover:bg-yellow-500 hover:text-black transition flex items-center justify-center">
                        <i class="fas fa-plus text-xs"></i>
                    </button>
                </div>
            </div>`;
    }).join('');
}
        function changeQty(id, delta) {
            const item = cart.find(i => i.id === id);
            item.quantity += delta;
            if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
            updateCart();
        }
        function clearCart() { if (confirm("¿Vaciar?")) { cart = []; updateCart(); toggleCart(); } }
        function openZoom(url) { document.getElementById('img-ampliada').src = url; document.getElementById('modal-zoom').style.display = 'flex'; }
        function closeZoom() { document.getElementById('modal-zoom').style.display = 'none'; }
      function checkoutWA() {
    const pedidoId = sessionStorage.getItem('ultimo_pedido_pago');
    
    if (!pedidoId) {
        alert("Debes completar el pago antes de enviar el pedido.");
        return;
    }

    let msg = `¡Hola Urban Riders! 👋\n`;
    msg += `✅ *PAGO CONFIRMADO DEL PEDIDO #${pedidoId}*\n\n`;
    msg += `*Detalle:* \n`;

    // Generamos el mensaje con los productos que SIGUEN en el carrito
    cart.forEach(item => { 
        msg += `• ${item.nombre} (Cant: ${item.quantity})\n`; 
    });
    
    msg += `\n*TOTAL: ${document.getElementById('cart-total').innerText}*`;
    
    // Abrimos el chat
    window.open(`https://wa.me/5493446645264?text=${encodeURIComponent(msg)}`, '_blank');

    // RECIÉN AHORA limpiamos todo para el próximo cliente
    sessionStorage.removeItem('ultimo_pedido_pago');
    localStorage.removeItem('cart_urban');
    cart = [];
    updateCart(); // El carrito se vacía y el botón vuelve a gris aquí
    closeCart();
}
function loadMore() {
            productosLimite += 12; // Aumentamos la cantidad a mostrar
            loadProducts();        // Recargamos el catálogo
        }
function toggleContactModal() {
            document.getElementById('contact-modal').classList.toggle('hidden');
        }

        document.getElementById('form-contacto-email')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('btn-envio-contacto');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    alert("¡Consulta enviada con éxito! Te responderemos a la brevedad.");
                    form.reset();
                    toggleContactModal();
                } else {
                    alert("Hubo un error al enviar el mensaje.");
                }
            } catch (error) {
                alert("Error de conexión con el servidor.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane text-lg"></i> Enviar Mensaje';
            }
        });

        window.onload = loadProducts;
// Lógica para el formulario del Club (Newsletter)
document.getElementById('newsletter-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const emailInput = document.getElementById('newsletter-email');
    const btn = e.target.querySelector('button');
    
    // Feedback visual para el usuario
    btn.disabled = true;
    const originalText = btn.innerText;
    btn.innerText = "UNIENDO...";

    try {
        const { error } = await _supabase
            .from('suscriptores') // Apuntamos a la tabla que me indicaste
            .insert([{ 
                email: emailInput.value 
                // La fecha_registro se genera sola por el 'default now()' de tu SQL
            }]);

        if (error) {
            // Si el email ya existe, Supabase devolverá un error por el constraint 'unique'
            if (error.code === '23505') {
                alert("Este correo ya forma parte del Club Urban Riders.");
            } else {
                throw error;
            }
        } else {
            alert("¡Te uniste al Club con éxito! Pronto recibirás novedades.");
            emailInput.value = ""; // Limpiamos el campo
        }
    } catch (err) {
        console.error("Error al suscribirse:", err);
        alert("Hubo un problema. Por favor, intenta más tarde.");
    } finally {
        btn.disabled = false;
        btn.innerText = originalText;
    }
});
// --- NUEVA FUNCIÓN INDEPENDIENTE ---
function habilitarBotonWhatsapp() {
    const pedidoIdPago = sessionStorage.getItem('ultimo_pedido_pago');
    const btnWpp = document.getElementById('btn-whatsapp-confirmar');
    
    if (!btnWpp) return;

    if (pedidoIdPago && cart.length > 0) {
        // MODO ACTIVO (Verde)
        btnWpp.classList.remove('opacity-50', 'pointer-events-none', 'text-green-600', 'border-green-600');
        btnWpp.classList.add('bg-green-600', 'text-white');
        btnWpp.innerHTML = `<i class="fab fa-whatsapp"></i> ENVIAR PEDIDO #${pedidoIdPago}`;
    } else {
        // MODO BLOQUEADO (Gris)
        btnWpp.classList.add('opacity-50', 'pointer-events-none', 'text-green-600', 'border-green-600');
        btnWpp.classList.remove('bg-green-600', 'text-white');
        btnWpp.innerHTML = `<i class="fab fa-whatsapp"></i> Consultar por WhatsApp`;
    }
}

// --- INICIALIZACIÓN Y GESTIÓN DE ESTADO ---
window.addEventListener('DOMContentLoaded', async () => {
    // 1. CARGA DEL CATÁLOGO (Esto devuelve los productos a la pantalla)
    await loadProducts();

    // 2. ANALISIS DE URL PARA MERCADO PAGO
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    const pedidoId = urlParams.get('pedido');

    // 3. LIMPIEZA DE SEGURIDAD
    // Si la URL no tiene éxito, borramos permisos viejos de WhatsApp
    if (status !== 'success') {
        sessionStorage.removeItem('ultimo_pedido_pago');
    }

    // 4. PROCESO DE RETORNO DE PAGO
    if (status === 'success' && pedidoId) {
        sessionStorage.setItem('ultimo_pedido_pago', pedidoId);
        
        // Actualizamos Supabase a 'pago'
        await _supabase.from('pedidos').update({ estado_pago: 'pago' }).eq('id', pedidoId);

        alert("¡Pago exitoso! El botón de WhatsApp ya está listo en tu carrito.");

        // --- LINEA DE LIMPIEZA DE URL ---
        // Esto borra los parámetros de la URL sin recargar la página para evitar el alert infinito al refrescar
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }
    
    // 5. REFRESCO DE VISTA (Esto activa el botón si corresponde)
    updateCart(); 
});
    </script>
</body>
</html>
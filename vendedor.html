<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Urban Riders | Vendedores</title>
<link rel="icon" type="image/png" href="img/logo-ur.png">
<link rel="apple-touch-icon" href="img/logo-ur.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; color: #f8fafc; margin: 0; }
        .app-container { max-width: 500px; margin: 0 auto; background-color: #ffffff; min-height: 100vh; color: #1e293b; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        /* Aumentamos el tamaño de la imagen de 70px a 90px */
        .img-producto { width: 90px; height: 90px; object-fit: cover; border-radius: 14px; }
        .btn-urban:active { transform: scale(0.97); }
/* ESTABILIZADOR DEFINITIVO */
        #step-2 { padding-top: 0 !important; }

        .header-vendedor-fijo {
    position: -webkit-sticky;
    position: sticky;
    /* Probamos con 72px para que baje un poquito y no se meta debajo del nav */
    top: 98px; 
    z-index: 30; 
    background-color: white;
    margin-left: -1rem; 
    margin-right: -1rem;
    padding: 10px 1rem;
    border-bottom: 2px solid #f1f5f9;
    /* Esto ayuda a que el navegador respete el límite */
    will-change: top;
}

#cliente-nombre {
    padding-right: 25px !important;
    display: inline-block;
    overflow: visible;
    white-space: nowrap;
}
    </style>
</head>
<body>

    <div class="app-container pb-32">
        <nav class="bg-black text-white p-6 sticky top-0 z-50">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter">URBAN RIDERS</h1>
<button onclick="logoutVendedor()" class="text-[10px] font-bold bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 transition uppercase tracking-tighter shadow-sm active:scale-95">
    <i class="fas fa-sign-out-alt mr-1"></i> Salir
</button>
                    <p class="text-[12px] text-red-600 font-black uppercase">Panel de Ventas</p>
                </div>
            </div>
        </nav>

        <section id="step-1" class="p-4">
    <h2 class="text-2xl font-black mb-4 uppercase italic">Seleccionar Cliente</h2>
    <input type="text" id="search-cliente" oninput="filtrarClientes()" placeholder="Buscar cliente..." 
        class="w-full p-5 mb-4 rounded-xl bg-gray-100 border-2 border-transparent focus:border-black outline-none font-bold text-lg">
<button onclick="openClientModal()" class="w-full mt-2 bg-yellow-500 text-black font-black py-3 rounded-xl uppercase text-sm shadow-lg">
    <i class="fas fa-user-plus mr-2"></i> Nuevo Cliente
</button>
    <div id="lista-clientes" class="space-y-3"></div>
</section>

<section id="step-2" class="hidden px-4 pt-0">
    <div class="header-vendedor-fijo">
        <div class="bg-gray-100 p-3 rounded-xl flex justify-between items-center border-l-4 border-black mb-3 shadow-sm">
            <div style="overflow: visible; margin-right: 10px;">
                <p class="text-[10px] font-bold text-gray-500 uppercase leading-none">Cliente:</p>
                <h2 id="cliente-nombre" class="text-base font-black uppercase italic"></h2>
            </div>
            <button onclick="vaciarYVolver()" class="text-red-600 font-bold text-[10px] flex flex-col items-center ml-auto">
                <i class="fas fa-trash-alt text-base mb-0.5"></i> BORRAR
            </button>
        </div>

        <input type="text" id="search-producto" oninput="filtrarProductos()" placeholder="Buscar producto..." 
            class="w-full p-3 rounded-xl bg-white border-2 border-black outline-none font-bold text-base shadow-md">
    </div>

    <div id="lista-productos" class="space-y-4 mt-4"></div>
</section>

<section id="step-3" class="hidden p-4">
    <div class="flex justify-between items-center mb-6">
        <button onclick="irAPaso2()" class="font-black text-base text-gray-400 uppercase"><i class="fas fa-arrow-left"></i> Volver</button>
        <h2 class="text-2xl font-black uppercase italic">Resumen</h2>
    </div>
    <div id="lista-carrito" class="space-y-3 mb-6"></div>
</section>

        <div id="info-carrito" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 w-[90%] max-w-[400px] bg-black/90 backdrop-blur-md rounded-2xl p-3 shadow-2xl z-50 border border-white/20">
    <div class="flex items-center justify-between gap-4">
        <div class="flex flex-col">
            <span class="text-[10px] text-gray-400 uppercase font-bold leading-none">Total Pedido</span>
            <span id="total-carrito" class="text-lg font-black text-white leading-none"></span>
        </div>

        <button id="btn-accion-principal" onclick="manejarBotonPrincipal()" 
            class="bg-yellow-500 text-black px-6 py-2.5 rounded-xl font-black uppercase text-xs tracking-tighter flex items-center gap-2 active:scale-95 transition-transform">
            <span id="texto-boton">Ver Resumen</span>
            <i class="fas fa-chevron-right text-[10px]" id="icono-boton"></i>
        </button>
    </div>
</div>

    <script>
        // RECUERDA PONER TUS CREDENCIALES AQUÍ
        const SUPABASE_URL = 'https://dsexvmstfjadjdbptmzn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzZXh2bXN0ZmphZGpkYnB0bXpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2OTc3MzUsImV4cCI6MjA4MjI3MzczNX0.L0Wz3hwZOarNLqkYH5-RAzz2Y6iwI4uaE_rlkcKkgyg';  
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let clientes = [], productos = [], carrito = [], clienteSeleccionado = null;
// --- BLOQUE DE SEGURIDAD VENDEDOR ---
        // --- BLOQUE DE SEGURIDAD VENDEDOR MEJORADO ---
        _supabase.auth.onAuthStateChange(async (event, session) => {
            console.log("Evento Auth Vendedor:", event);

            if (!session) {
                window.location.replace("acceso.html"); 
                return;
            }

            // Consultamos a la base de datos usando la columna 'uid' (donde guardaste el código largo)
            const { data: perfil, error } = await _supabase
                .from('clientes')
                .select('tipo_cliente')
                .eq('auth_id', session.user.id)
                .single();

            // Si no encuentra el perfil, o el tipo_cliente NO es vendedor/admin, lo expulsa
            if (!perfil || (perfil.tipo_cliente !== 'vendedor' && perfil.tipo_cliente !== 'admin')) {
                console.log("Acceso denegado: Usuario sin permisos de vendedor.");
                window.location.replace("acceso.html"); 
                return;
            }

            // Si llega hasta aquí, es porque la base de datos confirmó que es vendedor
            if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
                init();
            }

            if (event === 'SIGNED_OUT') {
                window.location.replace("acceso.html");
            }
        });
        let vistaActual = 1;

        async function init() {
            const { data: c } = await _supabase.from('clientes').select('*').order('nombre');
            const { data: p } = await _supabase.from('productos').select('*').order('nombre');
            clientes = c || []; productos = p || [];
            renderClientes(clientes);
            renderProductos(productos);
        }

        function renderClientes(lista) {
            document.getElementById('lista-clientes').innerHTML = lista.map(c => {
                const saldoFormateado = Number(c.saldo || 0).toLocaleString();
                const colorSaldo = Number(c.saldo) !== 0 ? 'text-red-600' : 'text-gray-400';
                return `
                <div onclick="seleccionarCliente(${c.id})" class="bg-white border-2 border-gray-100 p-5 rounded-xl flex justify-between items-center btn-urban shadow-sm active:border-black">
                    <div>
                        <p class="font-black uppercase text-lg leading-tight mb-1">${c.nombre}</p>
                        <p class="text-xs font-bold uppercase tracking-tighter ${colorSaldo}">
                            Saldo Deudor: $${saldoFormateado}
                        </p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 text-xl"></i>
                </div>`;
            }).join('');
        }

        function seleccionarCliente(id) {
            clienteSeleccionado = clientes.find(c => c.id === id);
            vistaActual = 2;
            document.getElementById('cliente-nombre').innerText = clienteSeleccionado.nombre;
            actualizarVistas();
        }

        function renderProductos(lista) {
            document.getElementById('lista-productos').innerHTML = lista.map(p => {
                const item = carrito.find(i => i.id === p.id);
                const stockColor = p.stock > 0 ? 'text-green-600' : 'text-red-600';
                
                return `
                <div class="flex items-center gap-4 bg-white p-4 rounded-2xl border-2 border-gray-100 shadow-sm">
                    <div class="relative">
                        <img src="${p.imagen_url || 'https://via.placeholder.com/100'}" class="img-producto">
                        <span class="absolute -top-2 -right-2 bg-black text-white text-[11px] px-2.5 py-1 rounded-full font-bold border-2 border-white">
                            ${p.stock}
                        </span>
                    </div>
                    <div class="flex-1">
                        <p class="font-black text-base uppercase leading-tight mb-1">${p.nombre}</p>
                        <p class="text-red-600 font-black text-xl">$${p.precio}</p>
                        <p class="text-[11px] font-bold uppercase tracking-tighter ${stockColor}">
                            Disponible: ${p.stock} un.
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        ${item ? `
                            <button onclick="cambiarCant(${p.id}, -1)" class="w-10 h-10 rounded-full bg-gray-100 font-bold text-xl">-</button>
                            <span class="font-black text-lg">${item.cantidad}</span>
                            <button onclick="cambiarCant(${p.id}, 1)" class="w-10 h-10 rounded-full bg-black text-white font-bold text-xl" ${item.cantidad >= p.stock ? 'disabled style="opacity:0.3"' : ''}>+</button>
                        ` : `
                            <button onclick="cambiarCant(${p.id}, 1)" 
                                class="bg-gray-100 px-5 py-3 rounded-xl font-black text-xs uppercase ${p.stock <= 0 ? 'opacity-30 cursor-not-allowed' : ''}"
                                ${p.stock <= 0 ? 'disabled' : ''}>
                                ${p.stock > 0 ? 'Agregar' : 'Sin Stock'}
                            </button>
                        `}
                    </div>
                </div>`;
            }).join('');
            actualizarBarra();
        }

        function cambiarCant(id, delta) {
            const p = productos.find(x => x.id === id);
            const idx = carrito.findIndex(x => x.id === id);
            if (idx > -1) {
                carrito[idx].cantidad += delta;
                if (carrito[idx].cantidad <= 0) carrito.splice(idx, 1);
            } else {
                carrito.push({...p, cantidad: 1});
            }
            renderProductos(productos);
            if(vistaActual === 3) renderCarrito();
        }

        function renderCarrito() {
            document.getElementById('lista-carrito').innerHTML = carrito.map(i => `
                <div class="flex justify-between items-center bg-gray-50 p-5 rounded-xl border-2 border-gray-100">
                    <div class="flex-1">
                        <p class="font-black text-base uppercase leading-tight">${i.nombre}</p>
                        <p class="text-xs text-gray-500 font-bold uppercase">${i.cantidad} un. x $${i.precio}</p>
                    </div>
                    <div class="flex items-center gap-5">
                        <span class="font-black text-lg">$${(i.cantidad * i.precio).toLocaleString()}</span>
                        <button onclick="cambiarCant(${i.id}, -99)" class="text-red-500 text-2xl"><i class="fas fa-times-circle"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function manejarBotonPrincipal() {
            if (vistaActual === 2) {
                vistaActual = 3;
                renderCarrito();
            } else if (vistaActual === 3) {
                enviarPedido();
            }
            actualizarVistas();
        }

        function irAPaso2() { vistaActual = 2; actualizarVistas(); }

        function actualizarVistas() {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById(`step-${vistaActual}`).classList.remove('hidden');

            const btnTxt = document.getElementById('texto-boton');
            if (vistaActual === 2) {
                btnTxt.innerText = "Ver Resumen";
            } else if (vistaActual === 3) {
                btnTxt.innerText = "Confirmar y Enviar";
            }
        }

        function actualizarBarra() {
            const barra = document.getElementById('info-carrito');
            const total = carrito.reduce((acc, i) => acc + (i.precio * i.cantidad), 0);
            if (carrito.length > 0) {
                barra.classList.remove('hidden');
                document.getElementById('total-carrito').innerText = `$${total.toLocaleString()}`;
            } else {
                barra.classList.add('hidden');
            }
        }

        function vaciarYVolver() {
            if(confirm("¿Borrar pedido actual?")){
                carrito = []; clienteSeleccionado = null; vistaActual = 1;
                renderProductos(productos); actualizarVistas();
            }
        }

       async function enviarPedido() {
    const btn = document.getElementById('btn-accion-principal');
    btn.disabled = true; 
    btn.innerText = "ENVIANDO...";
    
    try {
        const total = carrito.reduce((acc, i) => acc + (i.precio * i.cantidad), 0);

        // --- ÚNICO CAMBIO: FIJAR FECHA ARGENTINA ---
        const ahora = new Date();
        const offsetArg = -3 * 60 * 60000; // Ajuste milisegundos para UTC-3
        const fechaArgentina = new Date(ahora.getTime() + offsetArg).toISOString().replace('Z', '-03:00');

        const { data: pedido, error: errP } = await _supabase.from('pedidos').insert([{
            cliente_id: clienteSeleccionado.id,
            cliente_nombre: clienteSeleccionado.nombre,
            total: total,
            estado: 'PENDIENTE',
            fecha: fechaArgentina // Se agrega la columna fecha
        }]).select().single();
        
        if (errP) throw errP;

        const detalles = carrito.map(i => ({
            pedido_id: pedido.id,
            producto_id: i.id,
            producto_nombre: i.nombre,
            cantidad: i.cantidad,
            precio_unitario: i.precio,
            subtotal: i.precio * i.cantidad
        }));
        
        const { error: errD } = await _supabase.from('pedido_detalles').insert(detalles);
        if (errD) throw errD;

        alert("✅ PEDIDO ENVIADO");
        location.reload(); // Tu lógica original para limpiar todo
    } catch (e) {
        alert("Error: " + e.message);
        btn.disabled = false;
        btn.innerText = "CONFIRMAR PEDIDO";
        if (typeof actualizarVistas === 'function') {
            actualizarVistas();
        }
    }
}
async function logoutVendedor() {
            if (confirm("¿Cerrar sesión de vendedor?")) {
                await _supabase.auth.signOut();
                // El vigilante de arriba detectará el SIGNED_OUT y mandará a acceso.html
            }
        }
/* --- INICIO BLOQUE NUEVO CLIENTE --- */
// Palabra clave: FUNCIONES_MODAL
function openClientModal() {
    const modal = document.getElementById('client-modal');
    if (modal) modal.classList.remove('hidden');
}

function closeClientModal() {
    const modal = document.getElementById('client-modal');
    const form = document.getElementById('form-nuevo-cliente');
    if (modal) modal.classList.add('hidden');
    if (form) form.reset();
}

// Palabra clave: ESCUCHADOR_SUBMIT
// Escuchamos a nivel documento para evitar el error de "null"
document.addEventListener('submit', async (e) => {
    if (e.target && e.target.id === 'form-nuevo-cliente') {
        e.preventDefault(); // EVITA RECARGA Y URL CON ?nombre=...
        
        const form = e.target;
        const btn = document.getElementById('btn-guardar-cliente');
        
        btn.disabled = true;
        btn.innerText = "GUARDANDO...";

        const nuevoCliente = {
            nombre: form.nombre.value,
            telefono: form.telefono.value,
            email: form.email.value,
            saldo: 0,
            limite_credito: 0,
            tipo_cliente: 'mayorista' // <--- AGREGAMOS ESTO AQUÍ
        };
        try {
            // Inserción en Supabase
            const { data, error } = await _supabase.from('clientes').insert([nuevoCliente]).select();
            
            if (error) throw error;

            alert("✅ CLIENTE CREADO EXITOSAMENTE");
            closeClientModal();
            
            // Limpiar buscador y refrescar lista
            document.getElementById('search-cliente').value = '';
            await await init(); // Esta función ya existe en tu vendedor.txt
            renderClientes(clientes); // Esta función también existe

        } catch (err) {
            console.error("Error detallado:", err);
            alert("Error al guardar: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "GUARDAR CLIENTE";
        }
    }
});
/* --- FIN BLOQUE NUEVO CLIENTE --- */

    </script>
<div id="client-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-3xl overflow-hidden shadow-2xl">
        <div class="bg-black p-6 text-white flex justify-between items-center">
            <h3 class="font-black uppercase tracking-tighter">Registrar Cliente</h3>
            <button onclick="closeClientModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <form id="form-nuevo-cliente" class="p-6 space-y-4">
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Nombre Completo</label>
                <input type="text" name="nombre" required class="w-full border-2 border-gray-100 rounded-xl p-3 focus:border-yellow-500 outline-none transition-all">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Teléfono</label>
                    <input type="text" name="telefono" class="w-full border-2 border-gray-100 rounded-xl p-3 focus:border-yellow-500 outline-none transition-all">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Email (Opcional)</label>
                    <input type="email" name="email" class="w-full border-2 border-gray-100 rounded-xl p-3 focus:border-yellow-500 outline-none transition-all">
                </div>
            </div>
            <button type="submit" id="btn-guardar-cliente" class="w-full bg-black text-white font-black py-4 rounded-2xl uppercase tracking-widest hover:bg-yellow-500 hover:text-black transition-all">
                Guardar Cliente
            </button>
        </form>
    </div>
</div>

</body>
</html>